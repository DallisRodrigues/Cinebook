package com.cinebook.movieservice.service;

import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.cache.annotation.Cacheable;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.cinebook.movieservice.entity.Movie;
import com.cinebook.movieservice.entity.Seat;
import com.cinebook.movieservice.repository.MovieRepository;
import com.cinebook.movieservice.repository.SeatRepository;

@Service
public class MovieService {

    @Autowired
    private MovieRepository movieRepo;

    @Autowired
    private SeatRepository seatRepo;

    // Initialize Data
    @Transactional
    public String initializeData() {
        Movie m = new Movie();
        m.setTitle("Avengers: Secret Wars");
        m.setDescription("The final chapter.");
        m = movieRepo.save(m);

        for (int i = 1; i <= 10; i++) {
            Seat s = new Seat();
            s.setSeatNumber("A" + i);
            s.setMovieId(m.getId());
            s.setStatus("AVAILABLE");
            seatRepo.save(s);
        }
        return "Data Initialized! Movie ID: " + m.getId();
    }

    // --- CACHING INTEGRATION HERE ---
    // When this is called, Spring checks Hazelcast RAM first.
    // If found, it returns INSTANTLY without touching the DB.
    // If not found, it runs the method and saves the result to RAM.
    @Cacheable(value = "movies", key = "#movieId")
    public List<Seat> getSeats(Long movieId) {
        System.out.println("âš¡ Fetching Seats from Database... (Cache Miss)"); // Log to prove it hits DB
        try {
            Thread.sleep(1000); // Artificial delay to simulate slow DB (Makes cache look awesome)
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        return seatRepo.findByMovieId(movieId);
    }

    // Book Seat logic
    @Transactional
    // Optional: @CacheEvict(value = "movies", allEntries = true) 
    // (Uncomment above if you want booking to clear cache, ensuring fresh data)
    public boolean bookSeat(Long seatId) {
        Seat seat = seatRepo.findById(seatId).orElse(null);
        
        if (seat != null && "AVAILABLE".equals(seat.getStatus())) {
            seat.setStatus("BOOKED");
            seatRepo.save(seat);
            return true;
        }
        return false;
    }
}