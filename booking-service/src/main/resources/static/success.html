<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Processing Booking... | CineBook</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />
    <script src="js/auth-interceptor.js"></script> 
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Manrope', 'sans-serif'] },
                    colors: { brand: { red: '#E50914', dark: '#0A0A0A', green: '#1EA83C' } }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0A0A0A; color: white; display: flex; align-items: center; justify-content: center; height: 100vh; font-family: 'Manrope', sans-serif; }
        .ticket-card { background: #1a1a1a; border-radius: 24px; overflow: hidden; position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.6); border: 1px solid #333; }
        .ticket-card::before, .ticket-card::after { content: ''; position: absolute; top: 72%; width: 34px; height: 34px; background: #0A0A0A; border-radius: 50%; border: 1px solid #333; }
        .ticket-card::before { left: -17px; } .ticket-card::after { right: -17px; }
        .dashed-line { border-top: 2px dashed #333; margin: 1.5rem 0; }
        .loader { border: 4px solid #222; border-top: 4px solid #E50914; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="processing-view" class="text-center">
        <div class="loader"></div>
        <h2 class="text-2xl font-extrabold tracking-tighter uppercase">Confirming Seats</h2>
        <p class="text-gray-500 text-xs font-bold mt-2 uppercase tracking-widest" id="status-text">Synchronizing with MariaDB...</p>
    </div>

    <div id="ticket-view" class="ticket-card w-full max-w-sm p-8 text-center hidden">
        <div class="w-16 h-16 bg-green-500/10 rounded-full flex items-center justify-center mx-auto mb-6">
            <span class="material-symbols-rounded text-4xl text-green-500">verified</span>
        </div>
        <h1 class="text-2xl font-black italic tracking-tighter mb-1 uppercase">Booking Success!</h1>
        <p class="text-gray-500 text-[10px] font-bold uppercase tracking-widest mb-6">Pass for <span id="user-email" class="text-white"></span></p>

        <div class="bg-[#222]/50 p-5 rounded-2xl mb-6 border border-white/5">
            <h2 class="font-black text-lg text-white uppercase italic leading-tight" id="ticket-movie-title"></h2>
            <p class="text-gray-500 text-[9px] font-black uppercase tracking-[0.2em] mt-2">CineBook India â€¢ Digital Entry</p>
            <div class="mt-4 flex justify-center gap-2 flex-wrap" id="seat-badge-container"></div>
        </div>

        <div class="dashed-line"></div>
        
        <div class="flex flex-col items-center gap-2">
            <div class="bg-white p-2 rounded-xl">
                <img id="dynamic-qr" src="" class="w-24 h-24">
            </div>
            <p class="text-[9px] text-gray-600 font-black tracking-[0.3em] uppercase mt-2">Scan for Admission</p>
        </div>

        <a href="http://localhost:8082/home.html" id="home-btn" onclick="sessionStorage.removeItem('pendingBooking')" 
           class="block w-full bg-brand-red py-4 rounded-xl font-black uppercase tracking-widest text-xs mt-8 hover:bg-red-700 transition-all transform active:scale-95">
            Back to Home (5s)
        </a>
    </div>

    <script>
        const API_GATEWAY = "http://localhost:8080";
        const MOVIE_HOME = "http://localhost:8082/home.html";

        document.addEventListener("DOMContentLoaded", async () => {
            // 1. Session Discovery (Resilient)
            let localUserId = localStorage.getItem('userId') || localStorage.getItem('id');
            let localUser = JSON.parse(localStorage.getItem('user') || "{}");
            const userId = localUserId || localUser.userId || localUser.id;
            const userEmail = localUser.email || "customer@cinebook.in";

            const statusText = document.getElementById('status-text');
            const dataStr = sessionStorage.getItem('pendingBooking');

            // --- REDIRECT LOGIC: HOME (8081) ---
            if (!userId || !dataStr) {
                statusText.innerText = "SESSION LOST. REDIRECTING HOME...";
                statusText.className = "text-red-500 font-black uppercase text-xs mt-4";
                setTimeout(() => { window.location.href = MOVIE_HOME; }, 2000);
                return;
            }

            const data = JSON.parse(dataStr);

            try {
                // 2. Database Sync (MariaDB via Booking Service)
                for (const seatId of data.seatIds) {
                    statusText.innerText = `SECURING SEAT ${seatId}...`;
                    
                    const url = `${API_GATEWAY}/bookings/create?userId=${userId}&seatId=${seatId}&movieId=${data.movieId}&email=${userEmail}&movieTitle=${encodeURIComponent(data.movieTitle)}`;
                    
                    const response = await fetch(url, { method: 'GET' });
                    if (!response.ok) throw new Error("MARIADB REJECTED REQUEST");
                }

                // 3. UI Reveal
                document.getElementById('processing-view').classList.add('hidden');
                document.getElementById('ticket-view').classList.remove('hidden');
                
                document.getElementById('user-email').innerText = userEmail;
                document.getElementById('ticket-movie-title').innerText = data.movieTitle;
                document.getElementById('dynamic-qr').src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=CINEBOOK-${userId}-${data.movieId}`;
                
                const seatContainer = document.getElementById('seat-badge-container');
                data.seatIds.forEach(id => {
                    const span = document.createElement('span');
                    span.className = "px-3 py-1 bg-white/10 border border-white/5 rounded-md text-[9px] text-white font-black uppercase";
                    span.innerText = "Seat " + id;
                    seatContainer.appendChild(span);
                });

                // 4. AUTO-REDIRECT TIMER (5 Seconds)
                let countdown = 5;
                const homeBtn = document.getElementById('home-btn');
                
                const timer = setInterval(() => {
                    countdown--;
                    homeBtn.innerText = `Back to Home (${countdown}s)`;
                    if (countdown <= 0) {
                        clearInterval(timer);
                        sessionStorage.removeItem('pendingBooking');
                        window.location.href = MOVIE_HOME;
                    }
                }, 1000);

            } catch (e) {
                console.error("Critical Sync Failure:", e);
                statusText.innerText = "SYNC FAILED. RETURNING TO HOME...";
                statusText.className = "text-red-500 font-black uppercase text-xs mt-4 animate-pulse";
                setTimeout(() => { window.location.href = MOVIE_HOME; }, 3000);
            }
        });
    </script>
</body>
</html>